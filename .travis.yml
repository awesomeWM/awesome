sudo: false
dist: trusty
language: none
services:
  - docker

cache:
  directories:
  - /tmp/dockerimgs

# Build only master and stable branches.  Other branches go through PRs.
branches:
  only:
    - master
    - 3.5

env:
  global:
    - DOCKER_RUN_ARGS="-e CI -e TRAVIS -e TRAVIS_BRANCH -e TRAVIS_COMMIT -e TRAVIS_JOB_NUMBER -e TRAVIS_PULL_REQUEST -e TRAVIS_JOB_ID -e TRAVIS_REPO_SLUG -e TRAVIS_TAG -e TRAVIS_OS_NAME"
    - COVERALLS_PARALLEL=true
    # COVERALLS_REPO_TOKEN=xxx
    - secure: "KDxXpepUky8agvfzG73f8EOkufTvVJA5fdE/+GAQ51OIn6NRLIYgvX3FuPw3PQxEOru7Bhiw/3+mfZrlYmjv8HeJx7/hfcVbYrnOK3ivBdNQSDXJo4DE6fTyT3gW1tsS09mw6r5zoBX46lIU+M1toPQPmVtt/cHQ8pCiC+I7mUs="
  matrix:
    - MAKE_ARGS="LUA_PKG=lua5.3 DO_COVERAGE=all"
    - MAKE_ARGS="LUA_PKG=lua5.2 DO_COVERAGE=all" SOURCE_DATE_EPOCH=1893456000
    - MAKE_ARGS="LUA_PKG=luajit DO_COVERAGE=all"
    - MAKE_ARGS="LUA_PKG=lua5.1" DOCKER_RUN_ARGS="$DOCKER_RUN_ARGS -e BUILD_IN_DIR=/tmp/awesome-build"

before_install:
  - if [ "$BUILD_APIDOC" = true ] && [ -n "$DO_COVERAGE" ]; then echo "BUILD_APIDOC and DO_COVERAGE are not meant to be used together." >&2; exit 1; fi
  - if [ -z $LUAINCLUDE ]; then LUAINCLUDE=/usr/include/${LUANAME}; fi
  - if [ -z $LUALIBRARY ]; then LUALIBRARY=/usr/lib/x86_64-linux-gnu/lib${LUANAME}.so; fi
  - cmake --version

script:
  - make -C docker docker_test $MAKE_ARGS DOCKER_IMGS_DIR=/tmp/dockerimgs

notifications:
  webhooks: https://coveralls.io/webhook?repo_token=$COVERALLS_REPO_TOKEN
