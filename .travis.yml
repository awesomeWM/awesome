sudo: false
dist: trusty
language: none
services:
  - docker

cache:
  directories:
  - /tmp/docker

# Build only master and stable branches.  Other branches go through PRs.
branches:
  only:
    - master
    - 3.5

env:
  DOCKER_RUN_ARGS=-e CI -e TRAVIS -e TRAVIS_BRANCH -e TRAVIS_COMMIT -e TRAVIS_JOB_NUMBER -e TRAVIS_PULL_REQUEST -e TRAVIS_JOB_ID -e TRAVIS_REPO_SLUG -e TRAVIS_TAG -e TRAVIS_OS_NAME
  matrix:
    - MAKE_ARGS="LUA_PKG=lua5.3 DO_COVERAGE=codecov"

before_install:
  - if [ "$BUILD_APIDOC" = true ] && [ -n "$DO_COVERAGE" ]; then echo "BUILD_APIDOC and DO_COVERAGE are not meant to be used together." >&2; exit 1; fi
  - if [ -z $LUAINCLUDE ]; then LUAINCLUDE=/usr/include/${LUANAME}; fi
  - if [ -z $LUALIBRARY ]; then LUALIBRARY=/usr/lib/x86_64-linux-gnu/lib${LUANAME}.so; fi
  - cmake --version

install:
  - DOCKER_IMAGE_CACHE="/tmp/docker/image-${TRAVIS_BUILD_NUMBER}.tar"
  - if [ -e "$DOCKER_IMAGE_CACHE" ]; then docker load -i "${DOCKER_IMAGE_CACHE}"; fi

script:
  - make -C docker docker_test $MAKE_ARGS

before_cache:
  - mkdir -p /tmp/docker; docker save awesomewm/awesome-base-current > "${DOCKER_IMAGE_CACHE}"
